'use strict';

var gBoard;
var size = 6;
var startTime;
var gameOver = false;

var gLevel = {
    SIZE: 4,
    MINES: 2
};

function onInit() {
    gBoard = createBoard();
    console.table(gBoard);
    startTime = Date.now();
    setInterval(updateTimer, 1000);
    fillBoardWithRandomCells(gBoard, 5); // Change 5 to the desired count
    renderBoard(gBoard);
}

function createBoard() {
    var board = [];
    for (var i = 0; i < size; i++) {
        board[i] = [];
        for (var j = 0; j < size; j++) {
            board[i][j] = { isMine: false, isShown: false, isMarked: false };
        }
    }
    return board;
}

function renderBoard(board) {
    var strHtml = '';
    for (var i = 0; i < size; i++) {
        strHtml += `<tr>`;
        for (var j = 0; j < size; j++) {
            strHtml += `<td 
                onclick="onCellClick(${i},${j}, this)" 
                oncontextmenu="onCellRightClick(event, ${i},${j}, this); return false;" 
                data-i="${i}" data-j="${j}" 
                class="${board[i][j].isShown ? '' : 'hidden'}">
                ${board[i][j].isShown ? (board[i][j].isMine ? '' : '') : ''}
            </td>`;
        }
        strHtml += `</tr>`;
    }
    const elBoard = document.querySelector('.my-table');
    elBoard.innerHTML = strHtml;
}

function updateTimer() {
    var currentTime = Date.now();
    var elapsedTime = currentTime - startTime;
    var seconds = Math.floor(elapsedTime / 1000);
    var minutes = Math.floor(seconds / 60);

    var timerElement = document.getElementById('timer');
    timerElement.innerHTML = 'timer:' + seconds % 60 + 's';
}

function fillBoardWithRandomCells(board, count) {
    var availablePositions = [];

    for (var i = 0; i < size; i++) {
        for (var j = 0; j < size; j++) {
            availablePositions.push({ i: i, j: j });
        }
    }

    shuffleArray(availablePositions);

    for (var idx = 0; idx < count; idx++) {
        var randomPosition = availablePositions[idx];
        board[randomPosition.i][randomPosition.j].isMine = true;
    }
}

function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;

    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }

    return array;
}

function onCellClick(i, j, elCell) {
    var cell = gBoard[i][j];

    if (!cell.isMarked && !cell.isShown) {
        if (cell.isMine) {
            elCell.innerHTML = '';
            endGame(false);
        } else {
            var minesAroundCount = countMinesAround(i, j);
            elCell.innerHTML = minesAroundCount > 0 ? minesAroundCount : '';
            cell.isShown = true;

            if (minesAroundCount === 0) {
                revealWide(i, j);
            }
        }
    }
}

function onCellRightClick(event, i, j, elCell) {
    event.preventDefault();

    var cell = gBoard[i][j];

    if (!cell.isShown) {
        cell.isMarked = !cell.isMarked;
        elCell.innerHTML = cell.isMarked ? '' : '';
    }
}

function countMinesAround(i, j) {
    var count = 0;

    for (var row = i - 1; row <= i + 1; row++) {
        for (var col = j - 1; col <= j + 1; col++) {
            if (row >= 0 && row < size && col >= 0 && col < size) {
                if (gBoard[row][col].isMine) {
                    count++;
                }
            }
        }
    }

    return count;
}

function revealWide(i, j) {
    for (var row = i - 1; row <= i + 1; row++) {
        for (var col = j - 1; col <= j + 1; col++) {
            if (row >= 0 && row < size && col >= 0 && col < size) {
                var elCell = document.querySelector(`[data-i="${row}"][data-j="${col}"]`);
                if (elCell.innerHTML === '' && !gBoard[row][col].isMine) {
                    var minesAroundCount = countMinesAround(row, col);
                    elCell.innerHTML = minesAroundCount;
                    if (minesAroundCount === 0) {
                        revealWide(row, col);
                    }
                }
            }
        }
    }
}


function endGame(isVictory) {
    console.log("endGame called");
    gameOver = true;

    var boardCells = document.querySelectorAll('.my-table td');
    boardCells.forEach(function(cell) {
        cell.onclick = null;
        cell.oncontextmenu = null;
    });
}

function restartGame() {
    onInit();
}

onInit();


//  注
'use strict';

var gBoard;
var size = 6;
var startTime;
var gCollectedMines = 0;
var gameOver = false;

var gLevel = {
    SIZE: 4,
    MINES: 2
};
var gGame = {
    isOn: false,
    shownCount: 0,
    markedCount: 0,
    secsPassed: 0
};

var gcells = [
    {minesAroundCount: 3, isShown: false, isMine: true, isMarked: false},
    {minesAroundCount: 2, isShown: true, isMine: true, isMarked: false},
    {minesAroundCount: 0, isShown: true, isMine: true, isMarked: false},
    // {minesAroundCount: 1, isShown: false, isMine: false, isMarked: false}
];


var gBoard;

function onInit() {
    gBoard = createBoard();
    console.log(gLevel);
    startTime = Date.now();
    setInterval(updateTimer, 1000);
    fillBoardWithRandomCells(gBoard, gcells, 5); // Change 5 to the desired count
    renderBoard(gBoard);

    console.table(gBoard);
}

function createBoard() {
    var board = [];
    for (var i = 0; i < size; i++) {
        board[i] = [];
        for (var j = 0; j < size; j++) {
            board[i][j] = '';
        }
    }
    return board;
}

function renderBoard(board) {
    var strHtml = '';
    for (var i = 0; i < size; i++) {
        strHtml += `<tr>`;
        for (var j = 0; j < size; j++) {
            // 注砖  住驻 转 拽 砖 'hidden' 
            // 砖转注砖 转 专 转 转 住转专
            strHtml += `<td onclick="onCellClick(${i},${j}, this)" data-i="${i}" data-j="${j}" class="hidden">${board[i][j]}</td>`;
        }
        strHtml += `</tr>`;
    }
    const elBoard = document.querySelector('.my-table');
    elBoard.innerHTML = strHtml;
}

function updateTimer() {
    var currentTime = Date.now();
    var elapsedTime = currentTime - startTime;
    var seconds = Math.floor(elapsedTime / 1000);
    var minutes = Math.floor(seconds / 60);

    var timerElement = document.getElementById('timer');
    timerElement.innerHTML = 'timer:' + seconds % 60 + 's';
}

function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;

    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }

    return array;
}

function fillBoardWithRandomCells(board, cells, count) {
    if (count > board.length * board[0].length) {
        throw new Error('Count exceeds the size of the board');
    }

    var availablePositions = [];
    for (var i = 0; i < board.length; i++) {
        for (var j = 0; j < board[i].length; j++) {
            availablePositions.push({ i: i, j: j });
        }
    }

    shuffleArray(availablePositions);

    for (var idx = 0; idx < count; idx++) {
        var randomPosition = availablePositions[idx];
        var cell = cells[Math.floor(Math.random() * cells.length)];

        // 爪 转 拽 cell  转
        board[randomPosition.i][randomPosition.j] = Object.assign({}, cell);

    }
}

var gMinesCount = 5;

function countMinesAround(i, j) {
    var count = 0;

    for (var row = i - 1; row <= i + 1; row++) {
        for (var col = j - 1; col <= j + 1; col++) {
            if (row >= 0 && row < size && col >= 0 && col < size) {
                if (gBoard[row][col].isMine) {
                    count++;
                }
            }
        }
    }

    return count;
}

function onCellClick(i, j, elCell) {
    var cellContent = gBoard[i][j];

    if (cellContent.isMine) {
        elCell.innerHTML = '';
        endGame(false); 
    } else {
        var minesAroundCount = countMinesAround(i, j);
        elCell.innerHTML = minesAroundCount;

        // 爪驻 住驻专 拽砖 住 爪专 专
        if (minesAroundCount === 0) {
            revealWide(i, j);
        }
    }

    elCell.classList.remove('hidden'); // 住专 转 拽 'hidden'  爪 转 转 砖 转
}

function revealWide(i, j) {
    for (var row = i - 1; row <= i + 1; row++) {
        for (var col = j - 1; col <= j + 1; col++) {
            if (row >= 0 && row < size && col >= 0 && col < size) {
                var elCell = document.querySelector(`[data-i="${row}"][data-j="${col}"]`);
                if (elCell.innerHTML === '' && !gBoard[row][col].isMine) {
                    var minesAroundCount = countMinesAround(row, col);
                    elCell.innerHTML = minesAroundCount;
                    if (minesAroundCount === 0) {
                        revealWide(row, col);
                    }
                }
            }
        }
    }
}

function endGame(isVictory) {
    console.log("endGame called");
    gameOver = true;

    var boardCells = document.querySelectorAll('.my-table td');
    boardCells.forEach(function(cell) {
        cell.onclick = null;
    });
}

function toggleDisplay() {
    var element = document.querySelector('.restart-button');
    if (element.style.display === 'none') {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }
}

function restartGame() {
    toggleDisplay();
    onInit()
}

function endGame(isWin) {
    toggleDisplay();
}

endGame(true); 

// function incrementMinesCount() {
// 	gCollectedMines-- // 砖 转 驻住 注    砖转 
// 	var elSpan = document.querySelector(".sum-container")
// 	elSpan.innerText = gCollectedMines
// }